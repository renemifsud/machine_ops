<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Machine Ops</title>

    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
        integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <!-- FA CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'css/style2.css')}}">
    <!-- Scrollbar Custom CSS -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">

    <!-- Bootsrap Toggle -->
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <!-- Font Awesome JS -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js"
        integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ"
        crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js"
        integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY"
        crossorigin="anonymous"></script>
</head>

<body>

    <div class="wrapper">
        <!-- Sidebar  -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3><a href="{{ url_for('main.home') }}">Machine Ops</a></h3>
            </div>

            <ul class="list-unstyled components">
                <li class="active">
                    {% if 'alerts' in selected %}
                    <a href="#alertSubmenu" data-toggle="collapse" aria-expanded="true"
                        class="dropdown-toggle">Alerts</a>
                    <ul class="collapse list-unstyled show" id="alertSubmenu">
                        {% else %}
                        <a href="#alertSubmenu" data-toggle="collapse" aria-expanded="false"
                            class="dropdown-toggle">Alerts</a>
                        <ul class="collapse list-unstyled" id="alertSubmenu">
                            {% endif %}
                            <li>
                                <a href="{{ url_for('main.triggering') }}">Firing</a>
                            </li>
                            <li>
                                <a href="{{ url_for('main.solved') }}">Solved</a>
                            </li>
                            <li>
                                <a href="{{ url_for('main.list_alerts') }}">All</a>
                            </li>
                            <li>
                                <a href="{{ url_for('main.bulk_alerts') }}">Bulk Import</a>
                            </li>
                            <li>
                                <a href="{{ url_for('main.bulk_select_alerts') }}">Bulk Select Solution</a>
                            </li>
                        </ul>
                </li>
                <li>
                    {% if 'solutions' in selected %}
                    <a href="#solutionsSubmenu" data-toggle="collapse" aria-expanded="true"
                        class="dropdown-toggle">Solutions</a>
                    <ul class="collapse list-unstyled show" id="solutionsSubmenu">
                        {% else %}
                        <a href="#solutionsSubmenu" data-toggle="collapse" aria-expanded="false"
                            class="dropdown-toggle">Solutions</a>
                        <ul class="collapse list-unstyled" id="solutionsSubmenu">
                            {% endif %}
                            <li>
                                <a href="{{ url_for('main.list_solutions') }}">All</a>
                            </li>
                            <li>
                                <a href="{{ url_for('main.bulk_solutions') }}">Bulk Import</a>
                            </li>
                        </ul>
                </li>
                <li>
                    {% if 'var_groups' in selected %}
                    <a href="#var_groupsSubmenu" data-toggle="collapse" aria-expanded="true"
                        class="dropdown-toggle">Variable Groups</a>
                    <ul class="collapse list-unstyled show" id="var_groupsSubmenu">
                        {% else %}
                        <a href="#var_groupsSubmenu" data-toggle="collapse" aria-expanded="false"
                            class="dropdown-toggle">Variable Groups</a>
                        <ul class="collapse list-unstyled" id="var_groupsSubmenu">
                            {% endif %}
                            <li>
                                <a href="{{ url_for('main.list_var_groups') }}">All</a>
                            </li>
                        </ul>
                </li>
                <li>
                    {% if 'playbooks' in selected %}
                    <a href="{{ url_for('main.list_playbooks') }}" aria-expanded="true">Playbooks</a>
                    {% else %}
                    <a href="{{ url_for('main.list_playbooks') }}" aria-expanded="false">Playbooks</a>
                    {% endif %}
                </li>
            </ul>
        </nav>

        <!-- Page Content  -->
        <div id="content">

            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">

                    <button type="button" id="sidebarCollapse" class="btn btn-info">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item active">
                                <a class="nav-link" href="#"></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#"></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#"></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#"></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            {% block main_content %}

            {% endblock %}
        </div>
    </div>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
        integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
        crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
        integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
        crossorigin="anonymous"></script>
    <!-- jQuery Custom Scroller CDN -->
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            var session = '{{ session }}'

            $('input').on('keydown', function (event) {
                var x = event.which;
                if (x === 13) {
                    event.preventDefault();
                }
            });


            $("#sidebar").mCustomScrollbar({
                theme: "minimal"
            });

            $('#sidebarCollapse').on('click', function () {
                $('#sidebar, #content').toggleClass('active');
                $('.collapse.in').toggleClass('in');
                $('a[aria-expanded=true]').attr('aria-expanded', 'false');
            });

            $('#variables').on('click', '*[id*=delete_key_value_pair]', function () {
                var id = parseInt($(this).attr('id').replace('delete_key_value_pair_', ''));
                var last_row = $('*[id*=variables_row_]:last');
                last_row.remove();
            });


            $('#add_key_value_pair').on('click', function () {
                var last_row = $('*[id*=variables_row_]:last');
                var last_row_id = parseInt(last_row.attr('id').replace("variables_row_", ""))
                var next_row_id = last_row_id + 1;
                var new_row = last_row.clone().prop('id', 'variables_row_' + next_row_id);
                new_row.find('input[name=var_type_option_' + last_row_id + ']').prop('name', 'var_type_option_' + next_row_id);
                new_row.find('input[id*=key_]:last').prop('id', 'key_' + next_row_id).val('');
                new_row.find('label[for*=key_]:last').prop('for', 'key_' + next_row_id);
                new_row.find('input[id*=value_]:last').prop('id', 'value_' + next_row_id).val('');
                new_row.find('label[for*=value_]:last').prop('for', 'value_' + next_row_id);
                new_row.find('input[id*=path_]:last').prop('id', 'path_' + next_row_id).val('');
                new_row.find('label[for*=path_]:last').prop('for', 'path_' + next_row_id);
                new_row.find('input[id*=fixed_]:last').prop('id', 'fixed_' + next_row_id).val('');
                new_row.find('label[for*=fixed_]:last').prop('for', 'fixed_' + next_row_id);
                var delete_buttons = $('*[id*=delete_key_value_pair_]:last');
                var delete_button_html = ''
                if (delete_buttons.length == 0) {
                    delete_button_html = '<div class="col-sm-2"><button id="delete_key_value_pair_2" type="button" class="btn btn-danger" style="margin-top: 38px;">&#x2212;</button></div>'
                    new_row.append(delete_button_html);
                }
                else {
                    new_row.find('button[id*=delete_key_value_pair]').prop('id', 'delete_key_value_pair_' + next_row_id);
                }

                last_row.after(new_row)
            });

            $('#solution_button').on('click', function () {
                var select = $('select#solution_select').children().length
                if (select <= 0) {
                    $.ajax({
                        headers: {
                            "Authorization": "Basic " + btoa(session + ":")
                        },
                        type: 'GET',
                        url: '{{ url_for("solutions.get_solutions") }}',
                        success: function (solutions) {
                            $('#solution_button').parent().append('<select id="solution_select" form="updateUserForm" name="solution_select" class="browser-default custom-select"></select>');
                            $('#solution_button').hide()
                            var solSelect = $('#solution_select')
                            solSelect.append('<option selected for="solutionSel">Select Solution</option>');
                            $.each(solutions, function (i, solution) {
                                solSelect.append('<option value="' + solution.id + '">' + solution.name + '</option>');
                            })
                        }
                    })
                }
                else {
                    $('#solution_button').hide()
                    $('#solution_select').show()
                }
            });

            $('#alert_field').on('keyup', function () {
                var query = $('select#alert_select').children().length

                $.ajax({
                    headers: {
                        "Authorization": "Basic " + btoa(session + ":")
                    },
                    type: 'GET',
                    url: '{{ url_for("alerts.get_alerts") }}',
                    success: function (solutions) {
                        $('#alert_button').parent().append('<select id="alert_select" form="updateUserForm" name="alert_select" class="browser-default custom-select"></select>');
                        $('#alert_button').hide()
                        var solSelect = $('#alert_select')
                        solSelect.append('<option selected for="solutionSel">Select Solution</option>');
                        $.each(solutions, function (i, solution) {
                            var name = solution.name.toLowerCase()
                            if (name.includes(query.toLowerCase())) {
                                solSelect.append('<option value="' + solution.id + '">' + solution.name + '</option>');
                            }
                        })
                    }
                })
            });

            $('#var_alert_search_button').on("click", function () {
                if ($('#dataPrint') !== null) {
                    $('#dataPrint').remove()
                }
                var alertId = $('#var_alert_search').val();
                $.ajax({
                    headers: {
                        "Authorization": "Basic " + btoa(session + ":")
                    },
                    type: 'GET',
                    url: '{{ url_for("alerts.get_alerts") }}' + alertId,
                    success: function (alert) {
                        $('#var_alert_search_button').parent().parent().after('<div id="dataPrint" class="form-group"><label>' + JSON.stringify(JSON.parse(alert.data), null, 4) + '</label></div>');
                    }
                })
            });


            $('#var_var_group_button').on('click', function () {
                var select = $('select#var_group_select').children().length
                if (select <= 0) {
                    $.ajax({
                        headers: {
                            "Authorization": "Basic " + btoa(session + ":")
                        },
                        type: 'GET',
                        url: '{{ url_for("playbooks.get_playbooks") }}',
                        success: function (playbooks) {
                            $('#var_var_group_button').parent().append('<select id="var_var_group_select" form="updateUserForm" name="var_var_group_select" class="browser-default custom-select"></select>');
                            $('#var_var_group_button').hide()
                            var solSelect = $('#var_var_group_select')
                            solSelect.append('<option selected for="solutionSel">Select Group</option>');
                            $.each(playbooks, function (i, playbook) {
                                solSelect.append('<option value="' + playbook.id + '">' + playbook.name + '</option>');
                            })
                        }
                    })
                }
                else {
                    $('#var_var_group_button').hide()
                    $('#var_var_group_select').show()
                }
            });

            $('#var_load_vars_button').on('click', function () {
                if ($('#varsPrint') !== null) {
                    $('#varsPrint').remove()
                }
                var selected = $('#var_playbook_select').children("option:selected").val();
                $.ajax({
                    headers: {
                        "Authorization": "Basic " + btoa(session + ":")
                    },
                    type: 'GET',
                    url: '{{ url_for("playbooks.get_playbooks") }}' + selected,
                    success: function (playbook) {
                        $('#var_alert_search_button').parent().parent().after('<div id="varsPrint" class="form-group"><label>' + playbook.extra_vars + '</label></div>');
                    }
                })

            });


            $('#alert_bulk_select').on('click', function () {
                var query = $("#selectAlertsQuery").val()
                $.ajax({
                    headers: {
                        "Authorization": "Basic " + btoa(session + ":")
                    },
                    data: { "query": query },
                    type: 'POST',
                    url: '{{ url_for("alerts.bulk_search") }}',
                    success: function (alerts) {
                        if ($('#selected_alerts_table') !== null) {
                            $('#selected_alerts_table').remove()
                        }

                        $('#alert_bulk_select').parent().parent().parent().parent().append('<table id=selected_alerts_table class="table table-bordered"><thead><tr><th scope="col">#</th><th scope="col">ID</th><th scope="col">Name</th><th scope="col">Solution</th><th scope="col">URL</th></tr></thead><tbody></tbody></table>')
                        var table = $('#selected_alerts_table').find("tbody")
                        $.each(alerts, function (i, alert) {
                            table.parent().append('<tr><th scope="row"> <input type="checkbox" checked=true name="selected" value="' + alert.id + '"> </th><td>' + alert.id + '</td><td>' + alert.name + '</td><td>' + alert.solution_id + '</td><td><a href="' + alert.location + '">View</a></td></tr>')
                        })
                        $('#alert_bulk_select_solution').show()
                        $('#alert_bulk_select_export').show()
                    }
                })
            });

            $('#alert_bulk_select_export').on('click', function () {

                alerts = []

                $.each($("input[type='checkbox']:checked"), function () {
                    alerts.push($(this).val());
                });

                data = { 'alerts': JSON.stringify(alerts) }

                $.ajax({
                    headers: {
                        "Authorization": "Basic " + btoa(session + ":")
                    },
                    data: { 'alerts': JSON.stringify(alerts) },
                    type: 'POST',
                    url: '{{ url_for("main.bulk_select_alerts_download") }}',
                    success: function (csv) {
                        var hiddenElement = document.createElement('a');
                        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                        hiddenElement.target = '_blank';
                        var dt = new Date();
                        var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
                        hiddenElement.download = 'alerts_' + time + '.csv';
                        hiddenElement.click();
                    }
                })
            });

            $('#alert_bulk_select_solution').on('click', function () {
                if ($('#solution_select') !== null) {
                    $('#solution_select').remove()
                }
                $.ajax({
                    headers: {
                        "Authorization": "Basic " + btoa(session + ":")
                    },
                    type: 'GET',
                    url: '{{ url_for("solutions.get_solutions") }}',
                    success: function (solutions) {
                        $('#alert_bulk_select_solution').parent().append('<select id="solution_select"  style="width: 50%;" form="updateUserForm" name="solution_select" class="browser-default custom-select"></select>');
                        var solSelect = $('#solution_select')
                        solSelect.append('<option selected for="solutionSel">Select Solution</option>');
                        $.each(solutions, function (i, solution) {
                            solSelect.append('<option value="' + solution.id + '">' + solution.name + '</option>');
                        })
                    }
                })
            });

            $('#alertUpdateBtn').on('click', function () {
                var selectedSolution = $("select#solution_select").children("option:selected");
                if (selectedSolution.val() != "Select Solution") {
                    var name = $("input[name=name]").val()
                    var data = $("textarea[name=data]").val()


                    $.ajax({
                        headers: {
                            "Authorization": "Basic " + btoa(session + ":")
                        },
                        type: 'POST',
                        url: '',
                        data: { 'name': name, 'data': data, 'solution': selectedSolution.val() },
                        success: function (alert) {
                            $('#staticName').val(alert['name'])
                            $('#staticSolution').val(selectedSolution.text())
                            $("#staticData").val(alert['data'])
                            $('#alertUpdateBtn').addClass('btn-success').removeClass('btn-danger');
                            $('#solution_button').show()
                            $('#solution_select').hide()
                        }
                    })
                }
            });


        });
    </script>
</body>

</html>